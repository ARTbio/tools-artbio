<tool id="lumpy_smoove" name="lumpy_smoove" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">
    <description>find structural variants using the smoove workflow</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="stdio" />
    <command detect_errors="exit_code"><![CDATA[
    @pipefail@
    @set_fasta_index@

    #if $set_plan.plan_choice=='pair':
        ln -s '$set_plan.normal_bam' normal.bam &&
        ln -f -s '$set_plan.normal_bam.metadata.bam_index' normal.bam.bai &&
        ln -s '$set_plan.tumor_bam' tumor.bam &&
        ln -f -s '$set_plan.tumor_bam.metadata.bam_index' tumor.bam.bai &&
    #elif $set_plan.plan_choice=='single':
        ln -s '$set_plan.single_bam' single.bam &&
        ln -f -s '$set_plan.single_bam.metadata.bam_index' single.bam.bai &&
    #else:
        #for $sample in $set_plan.cohort:
            ln -s '$sample' '${sample.element_identifier}.bam' &&
            ln -f -s '$sample.metadata.bam_index' '${sample.element_identifier}.bam.bai' &&
        #end for
    #end if

    smoove call --name output
        #if $set_exclusion.choices=="yes":
            --exclude '$bedmask'
        #end if
            --fasta reference.fa
            --processes \${GALAXY_SLOTS:-4}
            --genotype
       #if $removepr:
            --removepr
       #end if
        *.bam &&
    gunzip -c output-smoove.genotyped.vcf.gz > '$vcf_call'

    ]]></command>
    <inputs>
        <expand macro="reference_source_conditional" />
        <conditional name="set_plan">
            <param name="plan_choice" type="select" label="Analysis mode" display="radio">
                <option value="pair" selected="true">A pair of BAM files (e.g., normal/tumor)</option>
                <option value="single">A single BAM file</option>
                <option value="cohort">A small cohort of BAM files (less than ~40)</option>
            </param>
            <when value="pair">
                <param format="bam" name="normal_bam" type="data" label="Normal/Reference sample BAM" />
                <param format="bam" name="tumor_bam" type="data" label="Tumor/Case sample BAM" />
            </when>
            <when value="single">
                <param format="bam" name="single_bam" type="data" label="Single sample BAM file" />
            </when>
            <when value="cohort">
                <param name="cohort" type="data_collection" format="bam" label="A collection of BAM files" />
            </when>
        </conditional>

        <conditional name="set_exclusion">
            <param name="choices" type="select" label="Exclude genomic regions?" display="radio">
                <option value="no" selected="true">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="yes">
                <param format="bed" name="bedmask" type="data" label="BED file with regions to exclude" help="This is highly recommended to improve specificity. See help section" />
            </when>
            <when value="no" />
        </conditional>
        <param name="removepr" type="boolean" checked="true" truevalue="--removepr" falsevalue="" label="Do not include PRPOS probabilities in INFO tags" help="Use this advanced option to exclude the PRPOS field, which can reduce VCF file size." />
    </inputs>

    <outputs>
        <data format="vcf" name="vcf_call" label="lumpy-smoove Variant Calling" />
    </outputs>

    <tests>
        <!-- Test 1: Paired mode with exclusion and removepr -->
        <test>
            <conditional name="set_plan">
                <param name="plan_choice" value="pair"/>
                <param name="normal_bam" value="celegans_RG_1.bam"/>
                <param name="tumor_bam" value="celegans_RG_2.bam"/>
            </conditional>
            <param name="reference_source_selector" value="history" />
            <param name="ref_file" value="chrI-ce11.fa"/>
            <conditional name="set_exclusion">
                <param name="choices" value="yes"/>
                <param name="bedmask" value="exclude.bed"/>
            </conditional>
            <param name="removepr" value="true"/>
            <output name="vcf_call" ftype="vcf" file="result_paired.vcf" lines_diff="12"/>
        </test>
        <!-- Test 2: Cohort mode -->
        <test>
            <conditional name="set_plan">
                <param name="plan_choice" value="cohort"/>
                <param name="cohort">
                    <collection type="list">
                        <element name="1" ftype="bam" value="celegans_RG_1.bam"/>
                        <element name="2" ftype="bam" value="celegans_RG_2.bam"/>
                    </collection>
                </param>
            </conditional>
            <param name="reference_source_selector" value="history" />
            <param name="ref_file" value="chrI-ce11.fa"/>
            <output name="vcf_call" ftype="vcf" file="result_cohort.vcf" lines_diff="12"/>
        </test>
        <!-- Test 3: Single mode with default options -->
        <test>
            <conditional name="set_plan">
                <param name="plan_choice" value="single" />
                <param name="single_bam" value="celegans_RG_1.bam"/>
            </conditional>
            <param name="reference_source_selector" value="history" />
            <param name="ref_file" value="chrI-ce11.fa"/>
            <conditional name="set_exclusion">
                <param name="choices" value="no"/>
            </conditional>
            <param name="removepr" value="false"/>
            <output name="vcf_call" ftype="vcf" file="result_single.vcf" lines_diff="12"/>
        </test>
    </tests>

    <help><![CDATA[
**What it does**

**smoove** simplifies and speeds up Structural Variant (SV) calling and genotyping for short reads. It improves specificity by removing many spurious alignment signals that are indicative of low-level noise and often contribute to spurious calls.

This Galaxy tool wraps `smoove` for single samples, pairs (e.g., normal/tumor), or small cohorts (<40 samples).

**Why exclude regions?**

The accuracy of SV detection can be greatly improved by excluding problematic regions of the genome. These regions often have highly repetitive sequences (like centromeres and telomeres) or are naturally highly variable (like immunoglobulin gene regions). Reads aligning to these areas can create ambiguous signals, leading to false-positive SV calls. Using a "blacklist" BED file is therefore highly recommended.

**Recommended Exclusion File**

Although this file was generated a few years ago, it is tied to the genome assembly version.

- **GRCh38 / hg38**: `https://github.com/hall-lab/speedseq/blob/master/annotations/exclude.cnvnator_100bp.GRCh38.20170403.bed`

**Inputs**

- **BAM files**: The tool accepts single, paired, or a collection of BAM files.
- **Reference Genome**: You must provide the reference genome that was used for the alignment.
- **Exclusion BED (Optional, but recommended)**: A BED file specifying regions to ignore during the analysis.

.. class:: warningmark

It is mandatory for a proper run that **BAM files contain read group information** (i.e., the @RG tag must be present in the BAM header).

**How it works**

`smoove` orchestrates a workflow that involves several tools. It intelligently parallelizes `lumpy` to detect breakpoints and `svtyper` to genotype the identified variants, resulting in a final VCF file.

**smoove GitHub**

For more detailed information, please refer to the `smoove` GitHub repository: https://github.com/brentp/smoove
    ]]></help>
    <citations>
        <citation type="doi">10.1186/gb-2014-15-6-r84</citation>
    </citations>
</tool>
