<tool id="probecoverage" name="Probe Coverage" version="0.1.0">
  <description></description>
  <requirements>
        <requirement type="package" version="1.4.1">samtools</requirement>
        <requirement type="package" version="2.26.0">bedtools</requirement>
        <requirement type="package" version="1.3.2=r3.3.1_0">r-optparse</requirement>
        <requirement type="package" version="2.2.1=r3.3.1_0">r-ggplot2</requirement>
        <requirement type="package" version="1.4.2=r3.3.1_0">r-reshape2</requirement>
  </requirements>
  <stdio>
      <exit_code range="1:" level="fatal" description="Tool exception" />
  </stdio>
  <command detect_errors="exit_code"><![CDATA[
      #for $file in $inputs
          samtools index '$file' &&
      #end for
      bedtools multicov
          -bams
              #for $file in $inputs
                  '$file'
              #end for
          -bed '$bed' > $bedtools_table &&
      Rscript '$__tool_directory__'/probecoverage.r
          --input '$bedtools_table' 
          --title 'Probe coverage depth (cumulative distribution)'
          --xlab 'Depth'
          --ylab 'Fraction of covered regions with coverage >= Depth'
          --output '$distribution'
          --sample "
              #for $file in $inputs 
                  $file.element_identifier,
              #end for
              "
              
  ]]></command>
 <inputs>
   <param name="inputs" type="data" format="bam" label="Select multiple Bam alignments to parse" multiple="True"/>
   <param name="bed" type="data" format="bed" label="Select a bed file describing the genomic regions to analyze" />
 </inputs>

 <outputs>
   <data format="tabular" name="bedtools_table" label="bedtools multicov output" />
   <data format="pdf" name="distribution" label="Cumulative distribution of region coverages" />
</outputs>

    <tests>
        <test>
            <param name="inputs" value="sample1,sample2,sample3" ftype="bam"/>
            <param name="bed" value="probes.bed" ftype="bed"/>
            <output file="coverage.tab" name="bedtools_table" />
            <output file="graph.pdf" name="distribution" />
        </test>
    </tests>


<help>

**What it does**

Generates counts of alignments from multiple position-sorted BAM files
that overlap intervals in a BED file.

Shows data as a cumulative plot of numbers of regions with coverage > x.	

**Inputs**

bam alignment files that must be

  - sorted
  - mapped to the same reference

**Output**

A data frame of computed counts

A pdf file generated by R

</help>

<citations>
    <citation type="doi">10.1093/bioinformatics/btq033</citation>
</citations>
</tool>

